---

   - name: Get current username
     shell: echo `whoami`
     register: ansible_username     

   - name: Install dependencies
     pip:
        name: "{{item}}"
        state: present
     with_items:
      - python

   - name: Install virtualenv
     become: yes
     become_method: sudo
     pip: 
       name: virtualenv

   - name: Check if virtualenv ~/hats folder exists
     become: yes
     become_method: sudo
     file:
         path: ~/hats
         state: absent

   - name: Create Virtual Env
     become: no
     shell: bash -lc "virtualenv ~/hats && source ~/hats/bin/activate"

   - name: Install functools for avoiding pip bug
     shell: bash -lc "source ~/hats/bin/activate && easy_install functools"

   - name: Install dependencies for Mac in Virtual Env 
     pip: 
        name: "{{item}}"
        virtualenv: ~/hats
     with_items:
      - pyobjc-core
      - pyobjc
      - pyautogui

   - name: Install requirements for Python pip
     pip: 
        requirements: "https://raw.githubusercontent.com/younglim/hats-ci/master/install-list/pip-install-list.txt"
        virtualenv: ~/hats

   - name: Download Chromedriver
     get_url: url="https://chromedriver.storage.googleapis.com/2.32/chromedriver_mac64.zip" dest=/tmp force=yes
   
   - name: Unzip Chromedriver
     unarchive: 
        src: "/tmp/chromedriver_mac64.zip"
        dest: "/tmp" 

   - name: Copy Chromedriver executable to /usr/local/share and set executable
     become: yes
     become_method: sudo
     copy:
        src: /tmp/chromedriver
        dest: /usr/local/share/chromedriver
        mode: 755

   - name: Symlink Chromedriver to /usr/local/bin
     file:
        src: /usr/local/share/chromedriver
        dest: /usr/local/bin/chromedriver
        state: link

   - name: Tap dupes for homebrew to install gnu tar
     homebrew_tap:
        name: homebrew/dupes
   
   - name: Install gnu tar for unzipping gecko tarball
     homebrew:
        name: gnu-tar
        state: present 

   - name: Download Firefox Gecko Driver
     get_url: url="https://github.com/mozilla/geckodriver/releases/download/v0.16.1/geckodriver-v0.16.1-macos.tar.gz" dest=/tmp force=yes
   
   - name: Unzip GeckoDriver
     unarchive: 
        src: "/tmp/geckodriver-v0.16.1-macos.tar.gz"
        dest: "/tmp" 

   - name: Copy GeckoDriver executable to /usr/local/share and set executable
     become: yes
     become_method: sudo
     copy:
        src: /tmp/geckodriver
        dest: /usr/local/share/geckodriver
        mode: 755

   - name: Symlink GeckoDriver to /usr/local/bin
     file:
        src: /usr/local/share/geckodriver
        dest: /usr/local/bin/geckodriver
        state: link 

   - name: Install Google Chrome and Firefox with Brew Cask
     homebrew_cask: 
        name: "{{ item }}"
        state: present
     with_items:
       - google-chrome
       - "caskroom/versions/firefox-esr"
       - chrome-devtools
     ignore_errors: true

   - name: Remove chrome downloads
     become: yes
     become_method: sudo
     file:
       path: "{{item}}"
       state: absent
     with_fileglob:
       - /tmp/chromedriver*

   - name: Remove gecko downloads
     become: yes
     become_method: sudo
     file:
       path: "{{item}}"
       state: absent
     with_fileglob:
       - /tmp/geckodriver*

   - name: Launch Firefox to start pref file
     shell: open -a Firefox 'http://www.google.com/'
    
   - name: Close Firefox after start pref file
     shell: pkill -f firefox

   - name: List firefox default profile folder (Firefox Config) 
     command: ls -v "~/Library/Application Support/Firefox/Profiles/"
     register: firefox_default_profile

   - name: insert update disabled (Firefox Config)
     lineinfile: 
        dest: "~/Library/Application Support/Firefox/Profiles/{{ firefox_default_profile.stdout.split(';')[0] }}/prefs.js"
        insertbefore: '^user_pref*'
        line: 'user_pref("app.update.enabled", false);' 
        state: present
    
   - name: insert no update (Firefox Config)
     lineinfile: 
        dest: "~/Library/Application Support/Firefox/Profiles/{{ firefox_default_profile.stdout.split(';')[0] }}/prefs.js"
        insertbefore: '^user_pref*'
        line: 'user_pref("app.update.auto", false);'
        state: present

   - name: insert no elevate update (Firefox Config)
     lineinfile: 
        dest: "~/Library/Application Support/Firefox/Profiles/{{ firefox_default_profile.stdout.split(';')[0] }}/prefs.js"
        insertbefore: '^user_pref*'
        line: 'user_pref("app.update.elevate.attempts", 0);'
        state: present

   - name: Add ~/.bash_profile if not present
     file: path=~/.bash_profile state=touch

   - name: Add to .bash_profile alias for hats_shell
     lineinfile: dest="~/.bash_profile" line='alias hats_shell=". ~/hats/bin/activate"' state=present
      