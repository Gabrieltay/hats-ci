---

   - name: Get current username
     shell: command echo `whoami`
     register: ansible_username     

   - name: Get Temp Directory
     shell: command echo `echo $TMPDIR`com.younglim.hats-ci
     register: ansible_tmpdir     

   - name: Install dependencies
     pip:
        name: "{{item}}"
        state: present
     with_items:
      - python

   - name: Install virtualenv
     pip:
       name: virtualenv

   - name: Check if virtualenv ~/hats folder exists
     file:
         path: ~/hats
         state: absent

   - name: Create Virtual Env
     shell: bash -lc "virtualenv ~/hats && source ~/hats/bin/activate"

   - name: Install functools for avoiding pip bug
     shell: bash -lc "source ~/hats/bin/activate && easy_install functools"

   - name: Install dependencies for Mac in Virtual Env 
     pip: 
        name: "{{item}}"
        virtualenv: ~/hats
     with_items:
      - pyobjc-core
      - pyobjc
      - pyautogui

   - name: Install requirements for Python pip
     pip: 
        requirements: "https://raw.githubusercontent.com/younglim/hats-ci/master/install-list/pip-install-list.txt"
        virtualenv: ~/hats

   - name: Install Google Chrome and Firefox with Brew Cask
     homebrew_cask: 
        name: "{{ item }}"
        state: present
     with_items:
       - google-chrome
       - firefox
       - chrome-devtools
     ignore_errors: true

   - name: Launch Firefox to start pref file
     shell: open -a Firefox 'http://www.google.com/'
    
   - name: Close Firefox after start pref file
     shell: pkill -f firefox

   - name: List firefox default profile folder (Firefox Config) 
     command: ls -v "~/Library/Application Support/Firefox/Profiles/"
     register: firefox_default_profile

   - name: Create Firefox Config if it does not exist
     file: path="~/Library/Application Support/Firefox/Profiles/{{ firefox_default_profile.stdout.split(';')[0] }}/prefs.js" state="touch"

   - name: Insert update disabled (Firefox Config)
     lineinfile: 
        dest: "~/Library/Application Support/Firefox/Profiles/{{ firefox_default_profile.stdout.split(';')[0] }}/prefs.js"
        insertbefore: '^user_pref*'
        line: 'user_pref("app.update.enabled", false);' 
        state: present
    
   - name: Insert no update (Firefox Config)
     lineinfile: 
        dest: "~/Library/Application Support/Firefox/Profiles/{{ firefox_default_profile.stdout.split(';')[0] }}/prefs.js"
        insertbefore: '^user_pref*'
        line: 'user_pref("app.update.auto", false);'
        state: present

   - name: Insert no elevate update (Firefox Config)
     lineinfile: 
        dest: "~/Library/Application Support/Firefox/Profiles/{{ firefox_default_profile.stdout.split(';')[0] }}/prefs.js"
        insertbefore: '^user_pref*'
        line: 'user_pref("app.update.elevate.attempts", 0);'
        state: present

   - name: Add ~/.bash_profile if not present
     file: path=~/.bash_profile state=touch

   - name: Add to .bash_profile alias for hats_shell
     lineinfile: dest="~/.bash_profile" line='alias hats_shell=". ~/hats/bin/activate && eval $@"' state=present
      
